<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>食事バランスモニタリングツール</title>
<link rel="manifest" href="manifest.json">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<style>
/* --- CSS は先ほどと同じ --- */
</style>
</head>
<body>
<div class="container">
<!-- ----------- 省略：HTML 部分はそのまま ----------- -->
</div>

<script>
/* Service Worker */
if('serviceWorker' in navigator){navigator.serviceWorker.register('./service-worker.js');}

/* 定数と変数 */
const STORAGE_KEY='mealData_v1';
const mealNames=[['breakfast','🌅 朝食'],['lunch','🌞 昼食'],['dinner','🌙 夕食']];
const foodGroups=[['staple','主食'],['side','副菜'],['main','主菜'],['dairy','乳・乳製品'],['fruit','果物']];
const recommended={staple:5,side:5,main:3,dairy:2,fruit:2};
let mealData={},chart;

/* 旧キー削除 */
if(localStorage.getItem('mealData') && !localStorage.getItem(STORAGE_KEY)){
  localStorage.removeItem('mealData');
}

/* --- UI 生成・操作系（createMealCards, changeCount, getTotals …）--- */
/* --- saveDailyRecord, clearAllData, drawChart, updateSummary など --- */

/* ===== CSV 書き出し（ヘッダー1行＋CRLF＋UTF‑8 BOM） ===== */
function downloadCSV(){
  if(Object.keys(mealData).length===0){
    alert('データがありません'); return;
  }
  const header=['date','staple','side','main','dairy','fruit','score'];
  let csv='\uFEFF'+header.join(',')+'\r\n';            // BOM + CRLF
  Object.keys(mealData).sort().forEach(dt=>{
    const m=mealData[dt];
    csv+=[dt,m.staple,m.side,m.main,m.dairy,m.fruit,m.score].join(',')+'\r\n';
  });
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download='meal_balance_records.csv';
  a.click();URL.revokeObjectURL(url);
}
/* =================================================== */

/* 初期化 */
function init(){
  document.getElementById('meal-date').valueAsDate=new Date();
  createMealCards();loadStorage();redraw({staple:0,side:0,main:0,dairy:0,fruit:0});updateTodayScore();
}
init();
</script>
</body>
</html>
