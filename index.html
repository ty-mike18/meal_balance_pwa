<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>食事バランスモニタリングツール</title>
<link rel="manifest" href="manifest.json">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<style>
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;max-width:1200px;margin:0 auto;padding:20px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:#333;}
    .container{background:#fff;border-radius:20px;padding:30px;box-shadow:0 20px 40px rgba(0,0,0,.1);}
    h1{text-align:center;color:#2c3e50;margin-bottom:30px;font-size:2.2em;}
    .input-section{background:#f8f9fa;padding:25px;border-radius:15px;margin-bottom:30px;border-left:5px solid #28a745;}
    .date-input{text-align:center;margin-bottom:20px;}
    .date-input input{padding:10px;border:2px solid #dee2e6;border-radius:8px;font-size:1.1em;}
    .meals-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:20px;}
    .meal-card{background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,.1);}
    .meal-card h3{color:#2c3e50;margin-bottom:15px;text-align:center;}
    .food-group{display:flex;justify-content:space-between;align-items:center;margin:10px 0;padding:8px;background:#f8f9fa;border-radius:8px;}
    .food-group label{font-weight:500;color:#495057;}
    .counter{display:flex;align-items:center;gap:10px;}
    .counter button{width:30px;height:30px;border:none;background:#007bff;color:#fff;border-radius:50%;cursor:pointer;font-weight:bold;}
    .counter button:hover{background:#0056b3;}
    .counter input{width:50px;text-align:center;border:1px solid #dee2e6;border-radius:5px;padding:5px;}
    .save-btn{background:linear-gradient(45deg,#28a745,#20c997);color:#fff;border:none;padding:15px 30px;font-size:1.1em;border-radius:25px;cursor:pointer;display:block;margin:20px auto;transition:transform .3s;}
    .save-btn:hover{transform:translateY(-2px);}
    .chart-section{background:#f8f9fa;padding:25px;border-radius:15px;margin-bottom:30px;}
    .chart-container{position:relative;height:400px;margin:20px 0;}
    .advice-section{background:#e3f2fd;padding:20px;border-radius:15px;border-left:5px solid #2196f3;}
    .advice-section h3{color:#1976d2;margin-bottom:15px;}
    .current-score{text-align:center;font-size:2em;color:#28a745;margin:20px 0;}
    .score-breakdown{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin:20px 0;}
    .score-item{background:#fff;padding:15px;border-radius:10px;text-align:center;box-shadow:0 2px 4px rgba(0,0,0,.1);}
    .clear-btn{background:#dc3545;color:#fff;border:none;padding:10px 20px;border-radius:20px;cursor:pointer;margin:10px;}
    .data-summary{background:#fff3cd;padding:15px;border-radius:10px;margin:20px 0;border-left:5px solid #ffc107;}
</style>
</head>
<body>
<div class="container">
    <h1>🍽️ 食事バランスモニタリングツール 📊</h1>
    <div class="input-section">
        <div class="date-input">
            <label for="meal-date">記録日：</label>
            <input type="date" id="meal-date">
        </div>
        <div class="meals-grid" id="meals-container"></div>
        <button class="save-btn" onclick="saveDailyRecord()">この日の記録を保存</button>
    </div>
    <div class="data-summary" id="data-summary">
        <h3>📈 記録データ概要</h3>
        <p id="summary-text">まだデータがありません。食事を記録してください。</p>
        <button class="clear-btn" onclick="clearAllData()">全データクリア</button>
    </div>
    <div class="chart-section">
        <h2>📊 食事バランススコアの推移</h2>
        <div class="current-score" id="current-score">今日のスコア: --点</div>
        <div class="chart-container"><canvas id="trendChart"></canvas></div>
        <div class="score-breakdown" id="score-breakdown"></div>
    </div>
    <div class="advice-section">
        <h3>💡 栄養士からのアドバイス</h3>
        <p id="advice-text">データを記録すると、あなたの食事パターンに基づいたアドバイスが表示されます。</p>
    </div>
</div>

<script>
if ('serviceWorker' in navigator){navigator.serviceWorker.register('./service-worker.js');}

const mealNames=[['breakfast','🌅 朝食'],['lunch','🌞 昼食'],['dinner','🌙 夕食']];
const foodGroups=[['staple','主食'],['side','副菜'],['main','主菜'],['dairy','乳・乳製品'],['fruit','果物']];
const recommendedServings={staple:5,side:5,main:3,dairy:2,fruit:2};
let mealData={};

// ---------- UI生成 ----------
function createMealCards(){
  const container=document.getElementById('meals-container');
  mealNames.forEach(([mealId,mealLabel])=>{
    const card=document.createElement('div');
    card.className='meal-card';
    card.innerHTML=`<h3>${mealLabel}</h3>`;
    const groupWrapper=document.createElement('div');
    groupWrapper.className='food-groups';
    groupWrapper.setAttribute('data-meal',mealId);
    foodGroups.forEach(([gId,gLabel])=>{
      const fg=document.createElement('div');
      fg.className='food-group';
      fg.innerHTML=`
        <label>${gLabel}</label>
        <div class="counter">
          <button onclick="changeCount('${mealId}-${gId}',-1)">-</button>
          <input type="number" id="${mealId}-${gId}" value="0" min="0" readonly>
          <button onclick="changeCount('${mealId}-${gId}',1)">+</button>
        </div>
      `;
      groupWrapper.appendChild(fg);
    });
    card.appendChild(groupWrapper);
    container.appendChild(card);
  });
}
// ---------- データ初期化 ----------
function loadData(){
  mealData=JSON.parse(localStorage.getItem('mealData')|| '{}');
}
function saveToLocal(){localStorage.setItem('mealData',JSON.stringify(mealData));}

// ---------- 既存ロジック（一部短縮） ----------
function changeCount(id,delta){
  const input=document.getElementById(id);
  input.value=Math.max(0,parseInt(input.value)+delta);
  updateCurrentScore();
}
function getCurrentDayData(){
  const totals={staple:0,side:0,main:0,dairy:0,fruit:0};
  mealNames.forEach(([m])=>foodGroups.forEach(([g])=>{
    totals[g]+=parseInt(document.getElementById(`${m}-${g}`).value)||0;
  }));
  return totals;
}
function calcScore(day){
  return Math.round(Object.keys(recommendedServings).reduce((s,k)=>s+Math.min(4,(day[k]/recommendedServings[k])*4),0)*10)/10;
}
function updateCurrentScore(){
  const date=document.getElementById('meal-date').value;if(!date)return;
  document.getElementById('current-score').textContent=`今日のスコア: ${calcScore(getCurrentDayData())}点`;
}
function saveDailyRecord(){
  const date=document.getElementById('meal-date').value;if(!date){alert('日付を選択');return;}
  mealData[date]={...getCurrentDayData(),score:calcScore(getCurrentDayData())};
  saveToLocal();
  updateChart();updateSummary();updateAdvice();updateBreakdown(mealData[date]);
  alert('保存しました');
}
function clearAllData(){
  if(confirm('全データを削除しますか？')){mealData={};saveToLocal();updateChart();updateSummary();
    document.getElementById('advice-text').textContent='データを記録すると...';
    document.getElementById('score-breakdown').innerHTML='';
    document.getElementById('current-score').textContent='今日のスコア: --点';
  }
}

// chart & advice 省略（元コードと同じ）
// --- 簡略化した placeholder ---
function updateChart(){}
function updateSummary(){document.getElementById('summary-text').textContent='データ件数: '+Object.keys(mealData).length;}
function updateAdvice(){}
function updateBreakdown(){}

// ---------- 初期実行 ----------
document.getElementById('meal-date').valueAsDate=new Date();
createMealCards();
loadData();
updateSummary();
</script>
</body>
</html>